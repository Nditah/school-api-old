{"version":3,"sources":["../src/chat.js"],"names":["dotenv","config","app","server","http","createServer","io","require","hostname","port","process","env","PORT","chatPort","PORT_CHAT","defaultPath","path","join","__dirname","use","bodyParser","urlencoded","extended","limit","json","express","static","database","on","console","error","bind","once","log","get","req","res","render","next","locals","userId","userType","role","peacegroupApi","pmtApi","pmlApi","Error","status","success","payload","message","listen","socket","data","broadcast","emit","user","msg","chatMessage","Chat","sender","save","id","err"],"mappings":"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","file":"chat.js","sourcesContent":["import \"babel-polyfill\";\r\nimport express from \"express\";\r\nimport bodyParser from \"body-parser\";\r\nimport morgan from \"morgan\";\r\nimport dotenv from \"dotenv\";\r\nimport cors from \"cors\";\r\n\r\nimport compression from \"compression\";\r\nimport path from \"path\";\r\nimport helmet from \"helmet\";\r\n\r\nimport http from \"http\";\r\n\r\n// import routes\r\nimport Chat from \"./api/general/chat/model\";\r\nimport { peacegroupApi, pmtApi, pmlApi } from \"./api\";\r\nimport database from \"./config\";\r\n\r\ndotenv.config();\r\nconst app = express();\r\nconst server = http.createServer(app);\r\nconst io = require(\"socket.io\")(server);\r\n\r\nconst hostname = \"0.0.0.0\"; // \"localhost\";\r\nconst port = process.env.PORT || 5000;\r\nconst chatPort = process.env.PORT_CHAT || 7000;\r\nconst defaultPath = path.join(__dirname, \"/public\");\r\n\r\napp.use(helmet());\r\napp.use(bodyParser.urlencoded({ extended: true, limit: \"50mb\" }));\r\napp.use(bodyParser.json({ limit: \"50mb\" }));\r\napp.use(morgan(\"dev\"));\r\napp.use(cors());\r\napp.use(compression());\r\napp.use(express.static(defaultPath));\r\n\r\ndatabase.on(\"error\", console.error.bind(console, \"Connection error:\"));\r\ndatabase.once(\"open\", () => {\r\n    console.log(\"Successfully connected to the database!\");\r\n});\r\n\r\napp.get(\"/\", (req, res) => {\r\n    console.log(\"defaultPath \", defaultPath);\r\n    res.render(`${defaultPath}/index.html`);\r\n});\r\n\r\napp.get(\"/chat\", (req, res) => {\r\n    console.log(`${defaultPath}/index.html`);\r\n    res.render(`${defaultPath}/index.html`);\r\n});\r\n\r\n// modify request object\r\napp.use((req, res, next) => {\r\n    res.locals.userId = 0.0;\r\n    res.locals.userType = \"anonymous\";\r\n    res.locals.role = \"\";\r\n    next();\r\n});\r\n\r\n// Use Routes\r\napp.use(\"/api\", peacegroupApi);\r\napp.use(\"/api\", pmtApi);\r\napp.use(\"/api\", pmlApi);\r\n\r\napp.use((req, res, next) => {\r\n    const error = new Error(\"Not found!\");\r\n    error.status = 404;\r\n    next(error);\r\n});\r\n\r\napp.use((error, req, res, next) => {\r\n    res.status(error.status || 500);\r\n    res.json({\r\n        success: false,\r\n        payload: null,\r\n        message: `SCHOOL API says ${error.message}`,\r\n    });\r\n    next();\r\n});\r\n\r\n// listen for requests\r\napp.listen(port, hostname, () => {\r\n    console.log(`Server running at http://${hostname}:${port}/`);\r\n});\r\n\r\n// setup event listener\r\nio.on(\"connection\", (socket) => {\r\n    console.log(\"user connected\");\r\n\r\n    socket.on(\"disconnect\", () => {\r\n        console.log(\"user disconnected\");\r\n    });\r\n\r\n    // Someone is typing\r\n    socket.on(\"typing\", (data) => {\r\n        socket.broadcast.emit(\"notifyTyping\", {\r\n            user: data.user,\r\n            message: data.message,\r\n        });\r\n    });\r\n\r\n    // when soemone stops typing\r\n    socket.on(\"stopTyping\", () => {\r\n        socket.broadcast.emit(\"notifyStopTyping\");\r\n    });\r\n\r\n    socket.on(\"chat message\", (msg) => {\r\n        console.log(`message: ${msg}`);\r\n\r\n        // broadcast message to everyone in port:5000 except yourself.\r\n        socket.broadcast.emit(\"received\", { message: msg });\r\n\r\n        // save chat to the database\r\n        const chatMessage = new Chat({ message: msg, sender: \"Anonymous\" });\r\n        chatMessage.save();\r\n\r\n        socket.on(\"disconnect\", () => {\r\n            console.log(\"client disconnect...\", socket.id);\r\n            // handleDisconnect();\r\n        });\r\n\r\n        socket.on(\"error\", (err) => {\r\n            console.log(\"received error from client:\", socket.id);\r\n            console.log(err);\r\n        });\r\n    });\r\n});\r\n\r\nserver.listen(chatPort, () => {\r\n    console.log(`ChatApp listens on port ${chatPort}`);\r\n});\r\n\r\nexport default app;\r\n"]}