{"version":3,"sources":["../../../../src/api/general/setup/controller.js"],"names":["req","res","accessToken","results","console","log","options","uri","setupUrls","method","auth","bearer","headers","json","Promise","all","map","setupUrl","message","setupSystem","params","subsidiary","folder","collection","Model","tablePath","path","join","__dirname","table","require","default","AccountClass","AccountHeading","Bank","BankAccount","Budget","Category","Table","Vehicle","State","Setting","Staff","Office","Report","DocumentType","OffenceType","Material","insertMany","result","logger","info","STATUS_MSG","SUCCESS","DEFAULT","error","setCollection","writeHead","find","sort","_id","limit","csv","downloadCsv","Object","keys","files","length","status","send","csvFile","file","csvString","data","toString","records","fromString","ignoreEmpty","on","mongoose","Types","ObjectId","push","create","then","newRecord","catch","err","uploadCsv","log4js","getLogger","configure","appenders","type","filename","categories","level","host","process","env","NODE_ENV","SERVER_DEV","SERVER_PROD"],"mappings":"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","file":"controller.js","sourcesContent":["/* eslint-disable global-require */\n/* eslint-disable complexity */\nimport log4js from \"log4js\";\nimport path from \"path\";\nimport rp from \"request-promise\";\nimport csv from \"fast-csv\";\nimport mongoose from \"mongoose\";\n\nimport AccountHeading from \"../account-heading/model\";\nimport AccountClass from \"../account-class/model\";\nimport Table from \"../table/model\";\nimport Staff from \"../staff/model\";\nimport Office from \"../office/model\";\nimport Report from \"../report/model\";\nimport Vehicle from \"../vehicle/model\";\nimport Budget from \"../budget/model\";\nimport County from \"../county/model\";\nimport State from \"../state/model\";\nimport Setting from \"../setting/model\";\nimport Bank from \"../bank/model\";\nimport DocumentType from \"../document-type/model\";\nimport OffenceType from \"../offence-type/model\";\nimport BankAccount from \"../bank-account/model\";\nimport Material from \"../material/model\";\nimport Category from \"../category/model\";\nimport { success, fail, notFound } from \"../../../lib\";\nimport { STATUS_MSG } from \"../../../constants\";\nimport { getToken } from \"../../../middleware/authorization\";\n\n// Logging\nconst logger = log4js.getLogger(\"[setup]\");\nlog4js.configure({\n    appenders: { file: { type: \"file\", filename: \"logs/setup.log\" } },\n    categories: { default: { appenders: [\"file\"], level: \"debug\" } },\n});\n\nlet host;\nif (process.env.NODE_ENV === \"development\") {\n    host = process.env.SERVER_DEV;\n} else {\n    host = process.env.SERVER_PROD;\n}\n\nconst setupUrls = [\n    // `${host}/api/setups/preload/{subsidiary}/{folder}/{collection}`,\n    `${host}/api/setups/preload/general/account-class/account_class`,\n    `${host}/api/setups/preload/general/account-heading/account_heading`,\n    `${host}/api/setups/preload/general/staff/staff`,\n    `${host}/api/setups/preload/general/office/office`,\n    `${host}/api/setups/preload/general/vehicle/vehicle`,\n    `${host}/api/setups/preload/general/county/county`,\n    `${host}/api/setups/preload/general/state/state`,\n    `${host}/api/setups/preload/general/table/table`,\n    `${host}/api/setups/preload/general/setting/setting`,\n    `${host}/api/setups/preload/general/bank/bank`,\n    `${host}/api/setups/preload/general/bank-account/bank_account`,\n    `${host}/api/setups/preload/general/document-type/document_type`,\n    `${host}/api/setups/preload/general/offence-type/offence_type`,\n    `${host}/api/setups/preload/general/stage/stage`,\n];\n\nexport async function setupSystem(req, res) {\n    const accessToken = getToken(req);\n    let results;\n    console.log(\"\\nThis is token \\n\\n\\n\", accessToken);\n\n    const options = {\n        uri: setupUrls[ 0 ],\n        method: \"GET\",\n        auth: { bearer: accessToken },\n        headers: { \"User-Agent\": \"Request-Promise\" },\n        json: true,\n    };\n    try {\n        // results = await rp(options);\n        results = await Promise.all(setupUrls.map((setupUrl) => {\n            options.uri = setupUrl;\n            return rp(options);\n        }));\n    } catch (err) {\n        console.log(err.message);\n        return fail(res, 401, `Error settingup system ${err.message}`);\n    }\n    return success(res, 201, results, \"System Setup complete!\");\n}\n\nexport async function setCollection(req, res) {\n    const { subsidiary, folder, collection } = req.params;\n    let Model;\n\n    const tablePath = path.join(__dirname, `../../${subsidiary}/${folder}/table`);\n\n    // eslint-disable-next-line import/no-dynamic-require\n    const table = require(`${tablePath}`).default;\n    console.log(table);\n    try {\n        // eslint-disable-next-line default-case\n        switch (collection) {\n        case \"account_class\": Model = AccountClass; break;\n        case \"account_heading\": Model = AccountHeading; break;\n        case \"bank\": Model = Bank; break;\n        case \"bank_account\": Model = BankAccount; break;\n        case \"budget\": Model = Budget; break;\n        case \"category\": Model = Category; break;\n        case \"table\": Model = Table; break;\n        case \"vehicle\": Model = Vehicle; break;\n        case \"state\": Model = State; break;\n        case \"setting\": Model = Setting; break;\n        case \"staff\": Model = Staff; break;\n        case \"office\": Model = Office; break;\n        case \"report\": Model = Report; break;\n        case \"document_type\": Model = DocumentType; break;\n        case \"offence_type\": Model = OffenceType; break;\n        case \"material\": Model = Material; break;\n        default: return fail(res, 401, `Error invalid collection: ${collection}`);\n        }\n        const result = await Model.insertMany(table);\n        if (!result) {\n            logger.info(STATUS_MSG.SUCCESS.DEFAULT, []);\n            return notFound(res, \"Error: Bad Request: Model not found\");\n        }\n        return success(res, 201, result, \"Record created successfully!\");\n    } catch (err) {\n        logger.error(err);\n        return fail(res, 500, `Error creating record. ${err.message}`);\n    }\n}\n\nexport async function downloadCsv(req, res) {\n    const { collection } = req.params;\n    let Model;\n    try {\n        // eslint-disable-next-line default-case\n        switch (collection) {\n        case \"account_class\": Model = AccountClass; break;\n        case \"account_heading\": Model = AccountHeading; break;\n        case \"bank\": Model = Bank; break;\n        case \"bank_account\": Model = BankAccount; break;\n        case \"budget\": Model = Budget; break;\n        case \"category\": Model = Category; break;\n        case \"table\": Model = Table; break;\n        case \"vehicle\": Model = Vehicle; break;\n        case \"state\": Model = State; break;\n        case \"setting\": Model = Setting; break;\n        case \"staff\": Model = Staff; break;\n        case \"office\": Model = Office; break;\n        case \"report\": Model = Report; break;\n        case \"document_type\": Model = DocumentType; break;\n        case \"offence_type\": Model = OffenceType; break;\n        case \"material\": Model = Material; break;\n        default: return fail(res, 401, `Error invalid collection: ${collection}`);\n        }\n        res.writeHead(200, {\n            \"Content-Type\": \"text/csv\",\n            \"Content-Disposition\": `attachment; filename=${collection}.csv`,\n        });\n        // pipe file using mongoose-csv\n        return await Model.find().sort({ _id: 1 }).limit(100).csv(res);\n        // return res.status(200).send(result);\n    } catch (err) {\n        logger.error(err);\n        return fail(res, 500, `Error creating record. ${err.message}`);\n    }\n}\n\nexport async function uploadCsv(req, res) {\n    console.log(\"uploadCsv\");\n    const { collection } = req.params;\n    let Model;\n    try {\n        // eslint-disable-next-line default-case\n        switch (collection) {\n        case \"account_class\": Model = AccountClass; break;\n        case \"account_heading\": Model = AccountHeading; break;\n        case \"bank\": Model = Bank; break;\n        case \"bank_account\": Model = BankAccount; break;\n        case \"budget\": Model = Budget; break;\n        case \"category\": Model = Category; break;\n        case \"table\": Model = Table; break;\n        case \"vehicle\": Model = Vehicle; break;\n        case \"state\": Model = State; break;\n        case \"setting\": Model = Setting; break;\n        case \"staff\": Model = Staff; break;\n        case \"office\": Model = Office; break;\n        case \"report\": Model = Report; break;\n        case \"document_type\": Model = DocumentType; break;\n        case \"offence_type\": Model = OffenceType; break;\n        case \"material\": Model = Material; break;\n        default: return fail(res, 401, `Error invalid collection: ${collection}`);\n        }\n        if (Object.keys(req.files).length === 0) {\n            return res.status(400).send(\"No files were uploaded.\");\n        }\n        const csvFile = req.files.file;\n        const csvString = csvFile.data.toString();\n        const records = [];\n        return csv.fromString(csvString, { headers: true, ignoreEmpty: true })\n            .on(\"data\", (data) => {\n                data._id = new mongoose.Types.ObjectId();\n                records.push(data);\n            })\n            .on(\"end\", () => Model.create(records)\n                .then(newRecord => success(res, 201, records, `${newRecord.length} ${collection} record(s) created successfully!`))\n                .catch(err => fail(res, 422, `${err.message}`)));\n    } catch (error) {\n        logger.error(error);\n        return fail(res, 500, `Error creating record. ${error.message}`);\n    }\n}\n"]}