{"version":3,"sources":["../../../../src/api/general/multimedia/controller.js"],"names":["req","res","uploadLocally","err","message","name","body","url","files","path","data","created_by","console","log","Joi","validate","schemaCreate","error","newRecord","Image","save","result","logger","info","STATUS_MSG","SUCCESS","DEFAULT","createRecord","uploadToAws","location","end","addImageAws","query","filter","skip","limit","sort","projection","find","select","exec","fetchRecord","id","params","recordId","schemaUpdate","findOneAndUpdate","_id","new","updateRecord","findOneAndRemove","deleteRecord","dotenv","config","aws","update","secretAccessKey","process","env","SECRET_ACCESS_KEY","accessKeyId","ACCESS_KEY_ID","region","s3","S3","log4js","getLogger","configure","appenders","file","type","filename","categories","default","level","imageUrl","storedLocally","multer","diskStorage","destination","callback","appRoot","fieldname","Date","toISOString","originalname","storedOnAws","bucket","acl","metadata","fieldName","key","storage","array"],"mappings":"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","file":"controller.js","sourcesContent":["import Joi from \"joi\";\nimport log4js from \"log4js\";\nimport aqp from \"api-query-params\";\nimport aws from \"aws-sdk\";\nimport multer from \"multer\";\nimport multerS3 from \"multer-s3\";\nimport appRoot from \"app-root-path\";\nimport dotenv from \"dotenv\";\nimport Image, { schemaCreate, schemaUpdate } from \"./model\";\nimport { success, fail, notFound, isObjecId } from \"../../../lib\";\nimport { STATUS_MSG } from \"../../../constants\";\n\ndotenv.config();\n\naws.config.update({\n    secretAccessKey: process.env.SECRET_ACCESS_KEY,\n    accessKeyId: process.env.ACCESS_KEY_ID,\n    region: \"eu-west-2\",\n});\n\nconst s3 = new aws.S3();\n\n// Logging\nconst logger = log4js.getLogger(\"[image]\");\nlog4js.configure({\n    appenders: { file: { type: \"file\", filename: \"logs/image.log\" } },\n    categories: { default: { appenders: [\"file\"], level: \"debug\" } },\n});\n\nlet imageUrl;\n\nconst storedLocally = multer.diskStorage({\n    destination(req, file, callback) {\n        callback(null, `${appRoot}/src/upload/Images`);\n    },\n    filename(req, file, callback) {\n        imageUrl = `${file.fieldname}_${new Date().toISOString()}_${file.originalname}`;\n        callback(null, imageUrl);\n    },\n});\n\nconst storedOnAws = multerS3({\n    s3,\n    bucket: \"peacebucket\",\n    acl: \"public-read\",\n    metadata(req, file, callback) {\n        callback(null, { fieldName: file.fieldname });\n    },\n    key(req, file, callback) {\n        imageUrl = `${file.fieldname}_${new Date().toISOString()}_${file.originalname}`;\n        callback(null, imageUrl);\n    },\n});\n\nconst uploadLocally = multer({ storage: storedLocally }).array(\"image\", 3); // Field name and max count\nconst uploadToAws = multer({ storage: storedOnAws }).array(\"image\", 3);\n\nexport async function createRecord(req, res) {\n    return uploadLocally(req, res, async (err) => {\n        if (err) return fail(res, 422, `Error uploading image. ${err.message}`);\n        const { name } = req.body;\n        const url = req.files[ 0 ].path;\n        const data = { name, url, created_by: 1 };\n        console.log(data);\n        const { error } = Joi.validate(data, schemaCreate);\n        if (error) return fail(res, 422, `Error validating request data. ${error.message}`);\n        const newRecord = new Image(data);\n        try {\n            const result = await newRecord.save();\n            if (!result) {\n                logger.info(STATUS_MSG.SUCCESS.DEFAULT, []);\n                return notFound(res, \"Error: Bad Request: Model not found\");\n            }\n            return success(res, 201, result, \"Record created successfully!\");\n        } catch (errata) {\n            logger.error(errata);\n            return fail(res, 500, `Error creating record. ${errata.message}`);\n        }\n    });\n}\n\nexport async function addImageAws(req, res) {\n    return uploadToAws(req, res, async (err) => {\n        const { name } = req.body;\n        // const { error } = Joi.validate(data, schemaCreate);\n        // if (error) return fail(res, 422, `Error validating request data. ${error.message}`);\n\n        const url = req.files[ 0 ].location;\n        console.log(req.body, req.files[ 0 ]);\n        const data = { name, url };\n        if (err) return res.end(`Error uploading image. ${err.message}`);\n        const newRecord = new Image(data);\n        try {\n            const result = await newRecord.save();\n            if (!result) {\n                logger.info(STATUS_MSG.SUCCESS.DEFAULT, []);\n                return notFound(res, \"Error: Bad Request: Model not found\");\n            }\n            return success(res, 201, result, \"Record created successfully!\");\n        } catch (error) {\n            logger.error(error);\n            return fail(res, 500, `Error creating record. ${error.message}`);\n        }\n    });\n}\n\nexport async function fetchRecord(req, res) {\n    const { query } = req;\n    const { filter, skip, limit, sort, projection } = aqp(query);\n    try {\n        const result = await Image.find(filter)\n            .skip(skip)\n            .limit(limit)\n            .sort(sort)\n            .select(projection)\n            .exec();\n        if (!result) {\n            return notFound(res, \"Error: Bad Request: Model not found\");\n        }\n        logger.info(STATUS_MSG.SUCCESS.DEFAULT, []);\n        return success(res, 201, result, null);\n    } catch (err) {\n        logger.error(err);\n        return fail(res, 500, `Error retrieving record. ${err.message}`);\n    }\n}\n\nexport async function updateRecord(req, res) {\n    const data = req.body;\n    const { recordId: id } = req.params;\n    const { error } = Joi.validate(data, schemaUpdate);\n    if (error) return fail(res, 422, `Error validating request data. ${error.message}`);\n    try {\n        const result = await Image.findOneAndUpdate({ _id: id }, data, { new: true });\n        if (!result) {\n            return notFound(res, `Bad Request: Model not found with id ${id}`);\n        }\n        return success(res, 200, result, \"Record updated successfully!\");\n    } catch (err) {\n        logger.error(err);\n        return fail(res, 500, `Error updating record. ${err.message}`);\n    }\n}\n\nexport async function deleteRecord(req, res) {\n    const { recordId: id } = req.params;\n    try {\n        const result = await Image.findOneAndRemove({ _id: id });\n        if (!result) {\n            return notFound(res, `Bad Request: Model not found with id ${id}`);\n        }\n        return success(res, 200, result, \"Record deleted successfully!\");\n    } catch (err) {\n        logger.error(err);\n        return fail(res, 500, `Error deleting record. ${err.message}`);\n    }\n}\n"]}